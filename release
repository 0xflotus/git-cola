#!/bin/sh
. $(dirname $0)/common.sh

# Options
do_docs=false
do_website=false
do_tarball=false
do_win32=false
win32_installer=innosetup
do_upload=false
file_to_upload=

# Commands
GH_RELEASE="$META/github-release"

usage () {
	echo "$(basename "$0") [options]"
	echo
	echo "options:"
	echo "--all                     - build tarball, win32, docs, and web"
	echo "--tarball                 - build the tarball"
	echo "--tarball-dir             - specify the tarball release directory"
	echo "--doc                     - build the documentation"
	echo "--doc-dir <dir>           - specify the documentation directory"
	echo "--win32                   - build the win32 installer"
	echo "--win32-innosetup         - build the InnoSetup installer"
	echo "--win32-login <user@host> - specify the win32 host"
	echo "--win32-port <port #>     - specify the win32 ssh port number"
	echo "--win32-cola-dir <dir>    - specify the win32 cola repo path"
	echo "--win32-python-dir <dir>  - specify the win32 python directory"
	echo "--version <version>       - specify the version number"
	echo "--upload                  - upload release assets to github"
	echo "--upload-file <path>      - upload one release asset"
	exit 1
}

init_release () {
	if test -z "$vVERSION"
	then
		return 1
	fi
	if ! "$GH_RELEASE" get --show-id "$vVERSION"
	then
		commit=$(git rev-parse "$vVERSION""^{commit}")
		do_or_die "$GH_RELEASE" create "$vVERSION" "$commit"
	fi
}

build_docs () {
	title Building docs
	do_or_die make prefix="$DOCUMENT_ROOT" install-doc
}

build_tarball () {
	title Building tarball
	do_or_die make app-tarball
	if test "$do_upload" = true
	then
		upload_file git-cola-"$VERSION".app.tar.gz
	fi
}

build_win32_remotely () {
	case "$win32_installer" in
	innosetup)
		build_win32_innosetup
		;;
	pynsist)
		build_win32_pynsist
		;;
	*)
		echo 1>&2 "unknown win32 installer: $win32_installer"
		exit 1
		;;
	esac
}

build_win32_pynsist () {
	title Building pynsist installer

	do_or_die ssh -p $WIN32_SSH_PORT "$WIN32_LOGIN" '
		PATH='"$WIN32_PYTHON"':'"$WIN32_PYTHON/Scripts"':'"$WIN32_GIT"':'"$WIN32_NSIS"':"$PATH"
		export PATH
		cd '"$WIN32_COLA_DIR"' &&
		PYTHONPATH=./extras/qtpy &&
		export PYTHONPATH &&
		rm -rf build/nsis &&
		pynsist pynsist.cfg
	'
	do_or_die scp -P $WIN32_SSH_PORT \
		"$WIN32_LOGIN":"$WIN32_COLA_DIR"/build/nsis/"*.exe" .

	do_or_die ssh -p $WIN32_SSH_PORT \
		"$WIN32_LOGIN" "/bin/rm '$WIN32_COLA_DIR'/build/nsis/*.exe"

	do_or_die mv git-cola_"$VERSION".exe git-cola-"$VERSION".exe
	do_or_die chmod 644 git-cola-"$VERSION".exe
	do_or_die zip -9 -m git-cola-"$VERSION".windows.zip \
		-xi git-cola-"$VERSION".exe
	if test "$do_upload" = true
	then
		upload_file git-cola-"$VERSION".windows.zip
	fi
}

build_win32_innosetup () {
	title Building InnoSetup installer

	do_or_die ssh -p $WIN32_SSH_PORT "$WIN32_LOGIN" '
		PATH='"$WIN32_PYTHON"':'"$WIN32_GIT"':"$PATH"
		export PATH
		cd '"$WIN32_COLA_DIR"' &&
		PYTHONPATH=./extras/qtpy &&
		export PYTHONPATH &&
		contrib/win32/create-installer.sh
	'
	do_or_die scp -P $WIN32_SSH_PORT \
		"$WIN32_LOGIN":"$WIN32_COLA_DIR"/"*.exe" .

	do_or_die ssh -p $WIN32_SSH_PORT \
		"$WIN32_LOGIN" "/bin/rm '$WIN32_COLA_DIR'/*.exe"

	do_or_die chmod 644 git-cola-"$VERSION".exe
	do_or_die zip -9 -m git-cola-"$VERSION".windows.zip \
		-xi git-cola-"$VERSION".exe
	if test "$do_upload" = true
	then
		upload_file git-cola-"$VERSION".windows.zip
	fi
}

upload_file () {
	filename="$1"
	do_or_die "$GH_RELEASE" upload "$vVERSION" "$filename"
}

# Parse options
while test $# -gt 0
do
	case "$1" in
	--doc-dir)
		DOCUMENT_ROOT="$2"
		shift
		shift
		;;
	--all)
		# we no longer release the Mac OS X app.tar.gz
		# do_tarball=true
		do_win32=true
		do_docs=true
		do_upload=true
		shift
		;;
	--tarball)
		do_tarball=true
		shift
		;;
	--doc)
		do_docs=true
		shift
		;;
	--version)
		VERSION="$2"
		shift
		shift
		;;
	--win32)
		do_win32=true
		shift
		;;
	--win32-innosetup)
		win32_installer=innosetup
		shift
		;;
	--win32-pynsist)
		win32_installer=pynsist
		shift
		;;
	--win32-login)
		WIN32_LOGIN="$2"
		shift
		shift
		;;
	--win32-cola-dir)
		WIN32_COLA_DIR="$2"
		shift
		shift
		;;
	--win32-python-dir)
		WIN32_PYTHON="$2"
		shift
		shift
		;;
	--win32-port)
		WIN32_SSH_PORT="$2"
		shift
		shift
		;;
	--upload)
		do_upload=true
		shift
		;;
	--no-upload)
		do_upload=false
		shift
		;;
	--upload-file)
		do_upload=true
		file_to_upload="$2"
		shift
		shift
		;;
	--)
		shift
		break
		;;
	*)
		usage
		;;
	esac
done

if test "$do_tarball" = true || test "$do_upload" = true
then
	init_release
fi


if test "$do_tarball" = true
then
	build_tarball
fi

if test "$do_win32" = true
then
	build_win32_remotely
fi

if test "$do_docs" = true
then
	build_docs
fi

if test "$do_upload" = true && test -n "$file_to_upload"
then
	upload_file "$file_to_upload"
fi
